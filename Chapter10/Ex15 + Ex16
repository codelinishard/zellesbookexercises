from graphics import *
from math import *
from random import*

class Projectile:
    """Simulates the flight of a projectile"""
    
    def __init__(self, angle, velocity, height):
        """angle is the launch angle in degrees
        velocity is the initial velocity in meters/sec
        height is the initial height above ground"""
        self.xpos = 0.0
        self.ypos = height
        theta = angle * 3.14159 / 180.0
        self.xvel = velocity * cos(theta)
        self.yvel = velocity * sin(theta)
    
    def update(self, dt):
        """update position for dt seconds"""
        self.xpos = self.xpos + self.xvel * dt
        yvel1 = self.yvel - 9.8 * dt
        self.ypos = self.ypos + (self.yvel + yvel1) / 2.0 * dt
        self.yvel = yvel1
    
    def getY(self):
        """return current y position"""
        return self.ypos
    
    def getX(self):
        """return current x position"""
        return self.xpos

class Target:
    def __init__(self, center, width,win):
        self.width = width
        self.center = center
        self.x = center.getX()
        self.y = center.getY()
        self.hitbox = Rectangle(Point(self.x -width/2,self.y + self.y*1.1), Point(self.x +width/2, self.y))
        self.hitbox.draw(win)
        
    def checkhit(self,projectilecenter):
        Ycheck = projectilecenter.getY() <= (self.y + self.width/2) and projectilecenter.getY() >= (self.y - self.width/2)
        Xcheck = projectilecenter.getX() <= (self.x + self.width/2) and projectilecenter.getX() >= (self.x - self.width/2)
        return Xcheck and Ycheck
    
class ShotTracker:
    """ShotTracker will contain both a Projectile and a Circle. Its job is to
    make sure that these instance variables stay in sync with each other."""
    
    def __init__(self, win, angle, velocity, height):
        """win is the GraphWin to display the shot. angle, velocity,
        and height are initial projectile parameters."""
        self.proj = Projectile(angle, velocity, height)
        self.marker = Circle(Point(0, height), 3)
        self.marker.setFill("red")
        self.marker.setOutline("red")
        self.marker.draw(win)
    
    def update(self, dt):
        """Move the shot dt seconds farther along its flight"""
        # update the projectile
        self.proj.update(dt)
        
        # move the circle to the new projectile location
        center = self.marker.getCenter()
        dx = self.proj.getX() - center.getX()
        dy = self.proj.getY() - center.getY()
        self.marker.move(dx, dy)
    
    def getX(self):
        """return the current x coordinate of the shot's center"""
        return self.proj.getX()
    
    def getY(self):
        """return the current y coordinate of the shot's center"""
        return self.proj.getY()
    
    def undraw(self):
        """undraw the shot"""
        self.marker.undraw()


class InputDialog:
    """A custom window for getting simulation values (angle, velocity,
    and height) from the user."""
    
    def __init__(self, angle, vel, height):
        """Build and display the input window"""
        self.win = win = GraphWin("Initial Values", 200, 300)
        win.setCoords(0, 4.5, 4, .5)
        
        Text(Point(1, 1), "Angle").draw(win)
        self.angle = Entry(Point(3, 1), 5).draw(win)
        self.angle.setText(str(angle))
        
        Text(Point(1, 2), "Velocity").draw(win)
        self.vel = Entry(Point(3, 2), 5).draw(win)
        self.vel.setText(str(vel))
        
        Text(Point(1, 3), "Height").draw(win)
        self.height = Entry(Point(3, 3), 5).draw(win)
        self.height.setText(str(height))
        
        self.fire = Button(win, Point(1, 4), 1.25, .5, "Fire!")
        self.fire.activate()
        
        self.quit = Button(win, Point(3, 4), 1.25, .5, "Quit")
        self.quit.activate()
    
    def interact(self):
        """wait for user to click Quit or Fire button
        Returns a string indicating which button was clicked"""
        while True:
            pt = self.win.getMouse()
            if self.quit.clicked(pt):
                return "Quit"
            if self.fire.clicked(pt):
                return "Fire!"
    
    def getValues(self):
        """return angle, velocity, height values from the entries"""
        a = float(self.angle.getText())
        v = float(self.vel.getText())
        h = float(self.height.getText())
        return a, v, h
    
    def close(self):
        """close the input window"""
        self.win.close()


class Button:
    """A button is a labeled rectangle in a window.
    It is activated or deactivated with the activate()
    and deactivate() methods. The clicked(p) method
    returns true if the button is active and p is inside it."""
    
    def __init__(self, win, center, width, height, label):
        """Creates a rectangular button, eg:
        qb = Button(myWin, Point(30,25), 20, 10, 'Quit')"""
        w, h = width / 2.0, height / 2.0
        x, y = center.getX(), center.getY()
        self.xmax, self.xmin = x + w, x - w
        self.ymax, self.ymin = y + h, y - h
        p1 = Point(self.xmin, self.ymin)
        p2 = Point(self.xmax, self.ymax)
        self.rect = Rectangle(p1, p2)
        self.rect.setFill('lightgray')
        self.rect.draw(win)
        self.label = Text(center, label)
        self.label.draw(win)
        self.deactivate()
    
    def clicked(self, p):
        """Returns true if button active and p is inside"""
        return (self.active and
                self.xmin <= p.getX() <= self.xmax and
                self.ymin <= p.getY() <= self.ymax)
    
    def getLabel(self):
        """Returns the label string of this button."""
        return self.label.getText()
    
    def activate(self):
        """Sets this button to 'active'."""
        self.label.setFill('black')
        self.rect.setWidth(2)
        self.active = True
    
    def deactivate(self):
        """Sets this button to 'inactive'."""
        self.label.setFill('darkgrey')
        self.rect.setWidth(1)
        self.active = False


def main():
    # create animation window
    win = GraphWin("Projectile Animation", 640, 480, autoflush=False)
    win.setCoords(-10, -10, 210, 155)
    Line(Point(-10, 0), Point(210, 0)).draw(win)
    for x in range(0, 210, 50):
        Text(Point(x, -5), str(x)).draw(win)
        Line(Point(x, 0), Point(x, 2)).draw(win)
    
    # event loop, each time through fires a single shot
    angle, vel, height = 45.0, 40.0, 2.0
    inputwin = InputDialog(angle, vel, height)
    targetX= randrange(-10,210)
    targetwidth = randrange(10,50)
    target = Target(Point(targetX,0),targetwidth,win)
    text = Text(Point(100,80),"Fire until the target bolded line is hit")
    text.draw(win)
    while True:
        # interact with the user

        choice = inputwin.interact()
        
        if choice == "Quit":  # loop exit
            break
        
        # create a shot and track until it hits ground or leaves window
        angle, vel, height = inputwin.getValues()
        shot = ShotTracker(win, angle, vel, height)
        while 0 <= shot.getY() and shot.getX() <= 210:
            shot.update(1/500)
            update(1500)
        hitcheck = target.checkhit(Point(shot.getX(),shot.getY()))
        if hitcheck:
            text.setText("Congratulations. Target was hit. click to exit")
            win.getMouse()
            win.close()
            inputwin.close()
            return


main()
